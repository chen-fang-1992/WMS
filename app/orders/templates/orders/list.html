{% extends 'base.html' %}

{% load order_tags %}

{% block content %}
<style>
table {
	width: auto;
	table-layout: auto;
	border-collapse: collapse;
	max-width: 100%;
}
th {
	vertical-align: middle;
	line-height: 1;
	font-weight: 600;
	font-size: 0.75rem;
	text-align: center;
	white-space: normal;
	word-break: keep-all;
}
td {
	font-size: 0.75rem;
	text-align: center;
	vertical-align: middle;
	white-space: nowrap;
}
td.break-word {
	white-space: normal;
}
table select option {
	text-align-last: center;
}
.filter-input {
	width: 100%;
}
.filter-variety {
	width: 100%;
	max-width: 100%;
	box-sizing: border-box;
}
.reference {
	min-width: 60px;
	max-width: 60px;
}
.postcode {
	min-width: 60px;
	max-width: 60px;
}
.state {
	min-width: 60px;
	max-width: 60px;
}
.woo_status {
	min-width: 90px;
	max-width: 90px;
}
.status {
	min-width: 90px;
	max-width: 90px;
}
.cursor-pointer {
	cursor: pointer;
}
.urgent-row {
	background-color: #ffedd5;
}
.urgent-row:hover {
	background-color: #fed7aa;
}
</style>

<div class="mx-auto p-1">
	<h2 class="font-semibold text-teal-700 text-lg pb-2">
		订单列表
		<span id="row-count" style="display: none; align-items: center; justify-content: center; min-width: 36px; padding: 2px 10px; font-size: 1rem !important; font-weight: 500; color: white; background: darkgrey; border-radius: 9999px; vertical-align: middle; height: 1.5rem; margin-bottom: 0.3rem;"></span>
	</h2>

	<!-- 顶部操作栏 -->
	<div class="flex items-center justify-between mt-4">
		<div class="flex items-center space-x-2">
			<button type="button" class="px-2 py-1 rounded-md bg-green-600 hover:bg-green-700" onclick="addOrder()">
				<i class="bi bi-plus-lg"></i> 添加订单
			</button>
			<button type="button" class="px-2 py-1 rounded-md bg-green-600 hover:bg-green-700 dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
				<i class="bi bi-file-earmark-arrow-down"></i> 导出勾选为
			</button>
			<ul class="dropdown-menu">
				<li><button id="export-orders-delivery-btn" type="button" class="dropdown-item">发货单</button></li>
				<li><button id="export-orders-selected-btn" type="button" class="dropdown-item">订单表</button></li>
			</ul>
			<button id="export-orders-btn" class="px-2 py-1 rounded-md bg-blue-600 hover:bg-blue-700">
				<i class="bi bi-file-earmark-arrow-down"></i> 导出订单
			</button>
			<button id="batch-update-btn" type="button" class="px-2 py-1 rounded-md bg-amber-600 hover:bg-amber-700">
				<i class="bi bi-check2-square"></i> 批量更新
			</button>
			{% if request.user.is_superuser %}
			<button id="sync-btn" class="px-2 py-1 rounded-md bg-green-600 hover:bg-green-700">
				<i class="bi bi-file-earmark-arrow-up"></i> 同步订单
			</button>
			{% endif %}
		</div>
	</div>

	<!-- 表格区域 -->
	<div class="mt-4 bg-white shadow-md rounded-lg w-full">
		<table class="w-full border-collapse text-sm w-100">
			<thead class="bg-gray-100">
				<tr>
					<th class="p-1 border border-gray-300"><input type="checkbox" id="select-all"></th>
					<th class="p-1 border border-gray-300 reference cursor-pointer" data-sort_field="reference">订单号码</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="date">日期</th>
					<th class="p-1 border border-gray-300 woo_status cursor-pointer" data-sort_field="woo_status">Woo</th>
					<th class="p-1 border border-gray-300 status cursor-pointer" data-sort_field="status">进度</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="contact_name">联系人</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="phone">电话</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="suburb">Suburb</th>
					<th class="p-1 border border-gray-300 postcode cursor-pointer" data-sort_field="postcode">Postcode</th>
					<th class="p-1 border border-gray-300 state cursor-pointer" data-sort_field="state">State</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="products">产品</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="total">总金额</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="shipping">运费</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="special_fees">特殊费用</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="route_record">路线记录</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="customer_notes">客户备注</th>
					<th class="p-1 border border-gray-300 cursor-pointer" data-sort_field="notes">备注</th>
					<th class="p-1 border border-gray-300">操作</th>
				</tr>
				<tr id="order-filter-row" style="visibility: hidden;">
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300 reference">
						<input data-search_target="reference" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="date" data-search_type="date" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300 woo_status">
						<select data-search_target="woo_status" class="filter-variety border border-gray-300 p-1 rounded">
							<option value="所有">所有</option>
							{% for value, label in woo_statuses %}
								<option value="{{ value }}">{{ label }}</option>
							{% endfor %}
						</select>
					</th>
					<th class="p-1 border border-gray-300 status">
						<select data-search_target="status" class="filter-variety border border-gray-300 p-1 rounded">
							<option value="所有">所有</option>
							<option value="Open">Open</option>
							{% for value, label in statuses %}
								<option value="{{ value }}">{{ label }}</option>
							{% endfor %}
						</select>
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="contact_name" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="phone" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="suburb" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300 postcode">
						<input data-search_target="postcode" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300 state">
						<select data-search_target="state" class="filter-variety border border-gray-300 p-1 rounded">
							<option value="">All</option>
							<option value="ACT">ACT</option>
							<option value="NSW">NSW</option>
							<option value="NT">NT</option>
							<option value="QLD">QLD</option>
							<option value="SA">SA</option>
							<option value="TAS">TAS</option>
							<option value="VIC">VIC</option>
							<option value="WA">WA</option>
						</select>
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="products" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="total" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="shipping" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="special_fees" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />	
					</th>
					<th class="p-1 border border-gray-300">
						<select data-search_target="route_record" class="filter-variety border border-gray-300 p-1 rounded">
							<option value="所有">所有</option>
							{% for value, label in route_records %}
								<option value="{{ value }}">{{ label }}</option>
							{% endfor %}
						</select>
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="customer_notes" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="notes" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300"></th>
				</tr>
			</thead>
			<tbody>
				{% for order in orders %}
				<tr class="{% if order.urgent %}urgent-row{% else %}hover:bg-gray-50{% endif %}">
					<td class="p-1 border border-gray-300"><input type="checkbox" class="order-checkbox" value="{{ order.id }}"></td>
					<td class="p-1 border border-gray-300 reference" data-search_field="reference">{{ order.reference | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="date">{{ order.date|date:"d/m/Y" }}<br>{{ order.date|date:"h:i A" }}</td>
					<td class="p-1 border border-gray-300 woo_status" data-search_field="woo_status" data-search_value="{{ order.woo_status|default:'' }}">{{ order.woo_status | woo_status_label }}</td>
					<td class="p-1 border border-gray-300 status" data-search_field="status">{{ order.status | status_label }}</td>
					<td class="p-1 border border-gray-300" data-search_field="contact_name">{{ order.contact_name | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="phone">{{ order.phone | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="suburb">{{ order.suburb | default:"" }}</td>
					<td class="p-1 border border-gray-300 postcode" data-search_field="postcode">{{ order.postcode | default:"" }}</td>
					<td class="p-1 border border-gray-300 state" data-search_field="state">{{ order.state | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="products">
						{% for line in order.lines.all %}
						<div>
							{{ line.raw_sku|default:"未知SKU" }} * {{ line.quantity }}
						</div>
						{% endfor %}
					</td>
					<td class="p-1 border border-gray-300" data-search_field="total">{{ order.total | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="shipping">{{ order.shipping | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="special_fees">
						{% if order.special_fees %}
							<i class="bi bi-info-circle fs-5 text-primary cursor-pointer" 
								data-bs-toggle="tooltip"
								data-bs-placement="top"
								title="{{ order.special_fees }}"></i>
							<span style="display: none;">{{ order.special_fees }}</span>
						{% endif %}
					</td>
					<td class="p-1 border border-gray-300" data-search_field="route_record">{{ order.route_record | route_record_label }}</td>
					<td class="p-1 border border-gray-300" data-search_field="customer_notes">
						{% if order.customer_notes %}
							<i class="bi bi-info-circle fs-5 text-primary cursor-pointer" 
								data-bs-toggle="tooltip"
								data-bs-placement="top"
								title="{{ order.customer_notes }}"></i>
							<span style="display: none;">{{ order.customer_notes }}</span>
						{% endif %}
					</td>
					<td class="p-1 border border-gray-300" data-search_field="notes">
						{% if order.notes %}
							<i class="bi bi-info-circle fs-5 text-primary cursor-pointer" 
								data-bs-toggle="tooltip"
								data-bs-placement="top"
								title="{{ order.notes }}"></i>
							<span style="display: none;">{{ order.notes }}</span>
						{% endif %}
					</td>
					<td class="p-1 border border-gray-300">
						<button class="text-primary hover:underline" onclick="editOrder(`{{ order.id }}`)"><i class="bi bi-pencil-square"></i></button>
						<button class="text-danger hover:underline ml-2" onclick="deleteOrder(`{{ order.id }}`)"><i class="bi bi-trash"></i></button>
						<button class="text-success hover:underline ml-2" onclick="getShippingQuotes(`{{ order.id }}`)">
							<i class="bi bi-truck"></i>
						</button>
					</td>
				</tr>
				{% empty %}
				<tr>
					<td colspan="9" class="p-1 text-center text-gray-500">没有订单数据。</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>

{% include 'orders/modal.html' %}

{% include 'orders/shipping_quotes.html' %}

<div class="modal fade" id="exportOrdersModal" tabindex="-1" aria-labelledby="exportOrdersModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exportOrdersModalLabel">导出订单</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="mb-3">
					<label for="export-modal-start-date" class="form-label">开始日期</label>
					<input id="export-modal-start-date" type="date" class="form-control">
				</div>
				<div class="mb-2">
					<label for="export-modal-end-date" class="form-label">结束日期</label>
					<input id="export-modal-end-date" type="date" class="form-control">
				</div>
				<div class="text-muted text-sm">请填写时间区间后再导出。</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
				<button type="button" class="btn btn-success" id="export-modal-confirm-btn">
					<i class="bi bi-file-earmark-arrow-down"></i> 导出
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="batchUpdateModal" tabindex="-1" aria-labelledby="batchUpdateModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="batchUpdateModalLabel">批量更新订单</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="mb-2 text-muted text-sm" id="batch-update-selected-count-text">已勾选 0 个订单</div>
				<div class="mb-2">
					<label for="batch-status-select" class="form-label">选择状态</label>
					<select id="batch-status-select" class="form-select">
						<option value="">请选择状态</option>
						{% for value, label in statuses %}
						<option value="{{ value }}">{{ label }}</option>
						{% endfor %}
					</select>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
				<button type="button" class="btn btn-warning" id="batch-update-confirm-btn">
					<i class="bi bi-check2-square"></i> 更新
				</button>
			</div>
		</div>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const filterVarietys = Array.from(document.getElementsByClassName('filter-variety'));
		const filterInputs = Array.from(document.getElementsByClassName('filter-input'));
		const productTable = document.querySelector('tbody');
		const headers = document.querySelectorAll('th[data-sort_field]');
		const exportBtn = document.getElementById('export-orders-delivery-btn');
		const exportSelectedOrdersBtn = document.getElementById('export-orders-selected-btn');
		const batchUpdateBtn = document.getElementById('batch-update-btn');
		const batchUpdateModalEl = document.getElementById('batchUpdateModal');
		const batchUpdateModal = batchUpdateModalEl ? new bootstrap.Modal(batchUpdateModalEl) : null;
		const batchStatusSelect = document.getElementById('batch-status-select');
		const batchUpdateSelectedCountText = document.getElementById('batch-update-selected-count-text');
		const batchUpdateConfirmBtn = document.getElementById('batch-update-confirm-btn');
		const exportOrdersBtn = document.getElementById('export-orders-btn');
		const exportModalEl = document.getElementById('exportOrdersModal');
		const exportModal = exportModalEl ? new bootstrap.Modal(exportModalEl) : null;
		const exportModalConfirmBtn = document.getElementById('export-modal-confirm-btn');
		const exportModalStartInput = document.getElementById('export-modal-start-date');
		const exportModalEndInput = document.getElementById('export-modal-end-date');
		let sortState = {};

		function normalizeNumber(text) {
			if (text == null) return null;
			// 去千分位、空格
			const clean = String(text).replace(/[, ]+/g, '');
			const n = Number(clean);
			return Number.isFinite(n) ? n : null;
		}

		function parseDate(text) {
			// 支持 YYYY, YYYY-MM, YYYY-MM-DD
			if (/^\d{4}$/.test(text)) {
				// 年份 -> 返回 1 月 1 日
				return new Date(text + '-01-01T00:00:00');
			}
			if (/^\d{4}-\d{2}$/.test(text)) {
				// 年-月 -> 返回该月 1 日
				return new Date(text + '-01T00:00:00');
			}
			if (/^\d{4}-\d{2}-\d{2}$/.test(text)) {
				return new Date(text + 'T00:00:00');
			}
			return null;
		}

		function cmp(a, b) {
			// 比较器：返回 -1/0/1
			if (a < b) return -1;
			if (a > b) return 1;
			return 0;
		}

		// 把“查询字符串 + 类型”编译成一个判断单元格文本是否命中的函数
		function buildPredicate(query, type) {
			const raw = (query || '').trim();
			if (!raw) {
				return () => true;
			}

			// 支持以空格分隔的 AND；以竖线 | 分隔的 OR
			// 例：">=10 <20"（AND），或者 "10-20|>=50"（OR）
			const orParts = raw.split('|').map(s => s.trim()).filter(Boolean);

			const tokenPredicates = orParts.map(orExpr => {
				const andTokens = orExpr.split(/\s+/).filter(Boolean).map(tok => tok.trim());
				const preds = andTokens.map(tok => makeTokenPredicate(tok, type));
				return (cellText) => preds.every(p => p(cellText));
			});

			return (cellText) => tokenPredicates.some(p => p(cellText));
		}

		function makeTokenPredicate(token, type) {
			// 统一处理：比较运算、区间、等值模糊
			// 支持：<=,>=,<,>,=,!=, 区间 a-b 或 a..b
			const opMatch = token.match(/^(<=|>=|<|>|=|!=)\s*(.+)$/);
			const rangeMatch = token.match(/^(.+?)(?:\.\.|-)(.+)$/);

			if (type === 'number') {
				return makeNumberPredicate(token, opMatch, rangeMatch);
			}
			if (type === 'date') {
				return makeDatePredicate(token, opMatch, rangeMatch);
			}
			// text：回退为大小写不敏感包含
			const rx = new RegExp(token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
			return (cellText) => rx.test(String(cellText || '').trim());
		}

		function makeNumberPredicate(token, opMatch, rangeMatch) {
			if (opMatch) {
				const [, op, rhsRaw] = opMatch;
				const rhs = normalizeNumber(rhsRaw);
				if (rhs == null) return () => false;
				return (cellText) => {
					const v = normalizeNumber(String(cellText || '').trim());
					if (v == null) return false;
					switch (op) {
						case '<=': return v <= rhs;
						case '>=': return v >= rhs;
						case '<':  return v <  rhs;
						case '>':  return v >  rhs;
						case '=':  return v === rhs;
						case '!=': return v !== rhs;
						default:   return false;
					}
				};
			}
			if (rangeMatch) {
				const lhs = normalizeNumber(rangeMatch[1]);
				const rhs = normalizeNumber(rangeMatch[2]);
				if (lhs == null || rhs == null) return () => false;
				const lo = Math.min(lhs, rhs);
				const hi = Math.max(lhs, rhs);
				return (cellText) => {
					const v = normalizeNumber(String(cellText || '').trim());
					return v != null && v >= lo && v <= hi;
				};
			}
			// 纯数字：等值；否则按包含
			const val = normalizeNumber(token);
			if (val != null) {
				return (cellText) => {
					const v = normalizeNumber(String(cellText || '').trim());
					return v === val;
				};
			}
			const rx = new RegExp(token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
			return (cellText) => rx.test(String(cellText || '').trim());
		}

		function makeDatePredicate(token, opMatch, rangeMatch) {
			if (opMatch) {
				const [, op, rhsRaw] = opMatch;
				const rhs = parseDate(rhsRaw);
				if (!rhs) return () => false;
				return (cellText) => {
					const v = parseDate(String(cellText || '').trim());
					if (!v) return false;
					switch (op) {
						case '<=': return cmp(v, rhs) <= 0;
						case '>=': return cmp(v, rhs) >= 0;
						case '<':  return cmp(v, rhs) <  0;
						case '>':  return cmp(v, rhs) >  0;
						case '=':  return cmp(v, rhs) === 0;
						case '!=': return cmp(v, rhs) !== 0;
						default:   return false;
					}
				};
			}
			if (rangeMatch) {
				const d1 = parseDate(rangeMatch[1]);
				const d2 = parseDate(rangeMatch[2]);
				if (!d1 || !d2) return () => false;
				const lo = d1 < d2 ? d1 : d2;
				const hi = d1 < d2 ? d2 : d1;
				return (cellText) => {
					const v = parseDate(String(cellText || '').trim());
					return !!v && v >= lo && v <= hi;
				};
			}
			// 纯日期：等值；否则按包含
			const val = parseDate(token);
			if (val) {
				return (cellText) => {
					const v = parseDate(String(cellText || '').trim());
					return !!v && cmp(v, val) === 0;
				};
			}
			const rx = new RegExp(token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
			return (cellText) => rx.test(String(cellText || '').trim());
		}

		function parseDateString(text) {
			// 支持格式：dd/mm/yyyy hh:mm AM/PM
			const match = text.match(/(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})\s*(AM|PM))?/i);
			if (!match) return null;

			let [, dd, mm, yyyy, hh, min, ap] = match;
			let hours = parseInt(hh || "0", 10);
			if (ap) {
				if (ap.toUpperCase() === "PM" && hours < 12) hours += 12;
				if (ap.toUpperCase() === "AM" && hours === 12) hours = 0;
			}

			return new Date(
				parseInt(yyyy, 10),
				parseInt(mm, 10) - 1,
				parseInt(dd, 10),
				hours,
				parseInt(min || "0", 10)
			);
		}

		function updateRowCount() {
			const counter = document.getElementById('row-count');
			if (!counter) return;
			const count = document.querySelectorAll('.order-checkbox').length;
			counter.textContent = count;
			counter.style.display = count > 0 ? 'inline-flex' : 'none';
		}

		function initBackendFilters() {
			const currentParams = new URLSearchParams(window.location.search);
			let submitTimer = null;
			const FILTER_INPUT_DEBOUNCE_MS = 1000;

			filterInputs.forEach(input => {
				const key = input.dataset.search_target;
				if (!key) return;
				input.value = currentParams.get(key) || '';
			});

			filterVarietys.forEach(select => {
				const key = select.dataset.search_target;
				if (!key) return;

				const rawValue = currentParams.get(key);
				if (rawValue === null) {
					if (key === 'status') {
						const hasOpen = Array.from(select.options).some(opt => opt.value === 'Open');
						if (hasOpen) {
							select.value = 'Open';
							return;
						}
					}
					select.selectedIndex = 0;
					return;
				}

				if (rawValue === '') {
					select.selectedIndex = 0;
					return;
				}

				const hasOption = Array.from(select.options).some(opt => opt.value === rawValue);
				if (hasOption) {
					select.value = rawValue;
				}
			});

			function buildNextParams() {
				const nextParams = new URLSearchParams(window.location.search);

				filterInputs.forEach(input => {
					const key = input.dataset.search_target;
					if (key) nextParams.delete(key);
				});
				filterVarietys.forEach(select => {
					const key = select.dataset.search_target;
					if (key) nextParams.delete(key);
				});

				filterInputs.forEach(input => {
					const key = input.dataset.search_target;
					if (!key) return;
					const value = (input.value || '').trim();
					if (value) nextParams.set(key, value);
				});

				filterVarietys.forEach(select => {
					const key = select.dataset.search_target;
					if (!key) return;
					const value = (select.value || '').trim();
					const isAllOption = select.selectedIndex === 0;

					if (key === 'status') {
						if (isAllOption) {
							nextParams.set('status', '');
						} else if (value) {
							nextParams.set('status', value);
						}
						return;
					}

					if (!isAllOption && value) {
						nextParams.set(key, value);
					}
				});

				return nextParams;
			}

			function submitFiltersNow() {
				const nextParams = buildNextParams();
				const nextQuery = nextParams.toString();
				const currentQuery = window.location.search.replace(/^\?/, '');
				if (nextQuery === currentQuery) return;
				window.location.search = nextQuery;
			}

			function submitFiltersDebounced() {
				if (submitTimer) clearTimeout(submitTimer);
				submitTimer = setTimeout(submitFiltersNow, FILTER_INPUT_DEBOUNCE_MS);
			}

			filterInputs.forEach(input => {
				input.addEventListener('input', submitFiltersDebounced);
				input.addEventListener('blur', function () {
					if (submitTimer) clearTimeout(submitTimer);
					submitFiltersNow();
				});
				input.addEventListener('keydown', function (e) {
					if (e.key === 'Enter') {
						e.preventDefault();
						if (submitTimer) clearTimeout(submitTimer);
						submitFiltersNow();
					}
				});
			});

			filterVarietys.forEach(select => {
				select.addEventListener('change', function () {
					if (submitTimer) clearTimeout(submitTimer);
					submitFiltersNow();
				});
			});

			const filterRow = document.getElementById('order-filter-row');
			if (filterRow) {
				filterRow.style.visibility = 'visible';
			}
		}

		function applyAllFilters() {
			updateRowCount();
			return;
			const filters = {};

			// 收集下拉筛选器
			filterVarietys.forEach(select => {
				const field = select.dataset.search_target;
				const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
				if (!selectedValues.includes('所有')) {
					filters[field] = { type: 'select', values: selectedValues };
				}
			});

			// 收集文本输入筛选器
			filterInputs.forEach(input => {
				const field = input.dataset.search_target;
				const ftype = (input.dataset.search_type || 'text').toLowerCase(); // text | number | date
				const query = (input.value || '').trim();
				if (query) {
					filters[field] = {
						type: 'predicate',
						predicate: buildPredicate(query, ftype)
					};
				}
			});

			const rows = productTable.querySelectorAll('tr');
			let visibleCount = 0;
			rows.forEach(row => {
				let visible = true;

				for (const [field, filter] of Object.entries(filters)) {
					const cell = row.querySelector(`td[data-search_field="${field}"]`);
					if (!cell) continue;

					const cellText = cell.textContent.trim();
					const cellValue = (cell.dataset.search_value || cellText).trim();

					if (filter.type === 'select') {
						if (
							!filter.values.includes('所有') &&
							!filter.values.includes('Open') &&
							!(
								filter.values.includes(cellValue) ||
								(cellText === '' && filter.values.includes('空'))
							)
						) {
							visible = false;
							break;
						}
					} else if (filter.type === 'predicate') {
						if (!filter.predicate(cellText)) {
							visible = false;
							break;
						}
					}
				}

				// ⚡ 默认隐藏 completed / cancelled
				const statusCell = row.querySelector('td[data-search_field="status"]');
				if (statusCell) {
					const status = statusCell.textContent.trim().toLowerCase();

					// 如果用户没有筛选 status，则隐藏 completed/cancelled
					if (filters['status'] && filters['status'].values && filters['status'].values.includes('Open') && (status === 'completed' || status === 'cancelled')) {
						visible = false;
					}
				}
				
				row.style.display = visible ? '' : 'none';
				if (visible) visibleCount += 1;
			});

			const counter = document.getElementById('row-count');
			if (counter) {
				counter.textContent = visibleCount;
				counter.style.display = visibleCount > 0 ? 'inline-flex' : 'none';
			}
		}

		// 输入事件绑定
		filterInputs.forEach(input => {
			input.addEventListener('input', applyAllFilters);
		});

		// 下拉框事件绑定替换
		filterVarietys.forEach(select => {
			select.addEventListener('change', applyAllFilters);
		});

		// 可选：初始化默认值为“所有”
		filterVarietys.forEach(select => {
			let allOption;
			if (select.dataset.search_target == 'status') {
				allOption = select.querySelector('option[value="Open"]');
			} else {
				allOption = select.querySelector('option[value="所有"]');
			}
			if (allOption) {
				allOption.selected = true;
			}
		});

		// 全选功能
		document.getElementById('select-all').addEventListener('change', function() {
			document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = this.checked);
		});

		function getSelectedOrderIds() {
			return Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
		}

		function validateSelectedOrderIds(ids) {
			if (ids.length === 0) {
				alert('请先勾选需要导出的订单！');
				return false;
			}
			return true;
		}

		if (exportBtn) {
			exportBtn.addEventListener('click', function() {
				const ids = getSelectedOrderIds();
				if (!validateSelectedOrderIds(ids)) return;
				window.location.href = `/orders/export/?ids=${ids.join(',')}`;
			});
		}

		if (exportSelectedOrdersBtn) {
			exportSelectedOrdersBtn.addEventListener('click', function() {
				const ids = getSelectedOrderIds();
				if (!validateSelectedOrderIds(ids)) return;
				window.location.href = `/orders/export/?ids=${ids.join(',')}&export_type=orders`;
			});
		}

		if (batchUpdateBtn) {
			batchUpdateBtn.addEventListener('click', function() {
				const ids = getSelectedOrderIds();
				if (ids.length === 0) {
					alert('请先勾选要更新的订单！');
					return;
				}

				if (batchUpdateSelectedCountText) {
					batchUpdateSelectedCountText.textContent = `已勾选 ${ids.length} 个订单`;
				}
				if (batchStatusSelect) batchStatusSelect.value = '';
				if (batchUpdateModal) batchUpdateModal.show();
			});
		}

		if (batchUpdateConfirmBtn) {
			batchUpdateConfirmBtn.addEventListener('click', async function() {
				const ids = getSelectedOrderIds();
				if (ids.length === 0) {
					alert('请先勾选要更新状态的订单！');
					if (batchUpdateModal) batchUpdateModal.hide();
					return;
				}

				const nextStatus = (batchStatusSelect?.value || '').trim();
				if (!nextStatus) {
					alert('请先选择要批量更新的状态！');
					return;
				}

				if (!confirm(`确认将 ${ids.length} 个勾选订单状态更新为「${nextStatus}」吗？`)) return;

				try {
					const res = await fetch('/orders/batch-update/', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json;charset=UTF-8',
						},
						body: JSON.stringify({
							ids,
							status: nextStatus,
						}),
					});
					const data = await res.json().catch(() => ({}));
					if (!res.ok || !data.success) {
						alert('批量更新状态失败：' + (data.error || res.status));
						return;
					}
					if (batchUpdateModal) batchUpdateModal.hide();
					alert(`批量更新完成：匹配 ${data.matched_count ?? ids.length} 条，实际更新 ${data.updated_count ?? 0} 条`);
					location.reload();
				} catch (error) {
					alert('批量更新状态请求失败');
				}
			});
		}

		if (exportOrdersBtn && exportModal) {
			exportOrdersBtn.addEventListener('click', function() {
				exportModal.show();
			});
		}

		if (exportModalConfirmBtn) {
			exportModalConfirmBtn.addEventListener('click', function() {
				const startDate = exportModalStartInput?.value || '';
				const endDate = exportModalEndInput?.value || '';

				if (!startDate || !endDate) {
					alert('请先填写开始日期和结束日期！');
					return;
				}

				if (startDate > endDate) {
					alert('导出开始日期不能晚于结束日期！');
					return;
				}

				const params = new URLSearchParams();
				params.set('start_date', startDate);
				params.set('end_date', endDate);

				exportModal.hide();
				window.location.href = `/orders/export/?${params.toString()}`;
			});
		}

		const syncBtn = document.getElementById('sync-btn');
		if (syncBtn) {
			syncBtn.addEventListener('click', function() {
				if (!confirm('确认同步 WooCommerce 订单吗？')) return;

				const xhr = new XMLHttpRequest();
				xhr.open('POST', '/orders/sync/', true);
				xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');

				const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
				if (csrftoken) xhr.setRequestHeader('X-CSRFToken', csrftoken);

				xhr.onload = function() {
					if (xhr.status >= 200 && xhr.status < 300) {
						try {
							const data = JSON.parse(xhr.responseText);
							if (data.success) {
								alert('✅ 同步成功');
								location.reload();
							} else {
								alert('⚠️ 同步失败：' + (data.error || '未知错误'));
							}
						} catch (e) {
							alert('⚠️ 返回数据格式错误');
						}
					} else {
						alert('❌ 同步请求失败：' + xhr.status);
					}
				};

				xhr.onerror = function() {
					alert('❌ 网络错误，请检查服务器连接');
				};

				xhr.send();
			});
		}

		headers.forEach(header => {
			header.addEventListener('click', function () {
				const field = header.dataset.sort_field;
				const rows = Array.from(productTable.querySelectorAll('tr'));

				// 切换排序方向
				sortState[field] = sortState[field] === 'asc' ? 'desc' : 'asc';
				const direction = sortState[field];

				rows.sort((a, b) => {
					const cellA = a.querySelector(`td[data-search_field="${field}"]`);
					const cellB = b.querySelector(`td[data-search_field="${field}"]`);
					const valA = cellA ? cellA.textContent.trim() : '';
					const valB = cellB ? cellB.textContent.trim() : '';

					let cmp = 0;

					if (field === "date") {
						// ⚡ 特殊处理日期
						const dateA = parseDateString(valA);
						const dateB = parseDateString(valB);
						if (dateA && dateB) {
							cmp = dateA - dateB;
						} else {
							cmp = valA.localeCompare(valB, 'zh');
						}
					} else {
						// 数字优先
						const numA = parseFloat(valA.replace(/[^0-9.-]/g, ''));
						const numB = parseFloat(valB.replace(/[^0-9.-]/g, ''));
						if (!isNaN(numA) && !isNaN(numB)) {
							cmp = numA - numB;
						} else {
							cmp = valA.localeCompare(valB, 'zh');
						}
					}

					return direction === 'asc' ? cmp : -cmp;
				});

				// 重新插入排序后的行
				rows.forEach(row => productTable.appendChild(row));
			});
		});

		initBackendFilters();
		updateRowCount();

		const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
		tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
	});

	function addOrder() {
		// 清空表单
		document.getElementById('order-form').reset();
		document.getElementById('order-form').dataset.editingId = '';  // 清除编辑状态

		// 清空旧行
		const tbody = document.getElementById('product-table-body');
		tbody.innerHTML = '';

		// 打开 modal
		document.getElementById('orderModalLabel').textContent = '添加订单';
		const modal = new bootstrap.Modal(document.getElementById('orderModal'));
		modal.show();
	}

	function deleteOrder(id) {
		if (confirm(`确认删除订单`)) {
			// 调用后端删除接口
			fetch(`/orders/delete/${id}/`, {
				method: 'POST',
			}).then(res => {
				if (res.ok) location.reload();
				else alert('删除失败');
			});
		}
	}

	function toDatetimeLocal(date) {
		if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
			return '';
		}
		const pad = n => String(n).padStart(2, '0');
		return date.getFullYear() + '-' +
			pad(date.getMonth() + 1) + '-' +
			pad(date.getDate()) + 'T' +
			pad(date.getHours()) + ':' +
			pad(date.getMinutes());
	}

	function toDateLocal(date) {
		if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
			return '';
		}
		const pad = n => String(n).padStart(2, '0');
		return date.getFullYear() + '-' +
			pad(date.getMonth() + 1) + '-' +
			pad(date.getDate());
	}

	function editOrder(id) {
		fetch(`/orders/detail/${id}/`)
		.then(res => res.json())
		.then(data => {
			if (!data.success) {
				alert('获取订单信息失败: ' + data.error);
				return;
			}

			const order = data.order;

			// 填充基本信息
			const date = new Date(order.date);
			document.getElementById('reference').value = order.reference || '';
			document.getElementById('date').value = toDatetimeLocal(date);
			document.getElementById('contact_name').value = order.contact_name || '';
			document.getElementById('phone').value = order.phone || '';
			document.getElementById('email').value = order.email || '';
			document.getElementById('address').value = order.address || '';
			document.getElementById('suburb').value = order.suburb || '';
			document.getElementById('postcode').value = order.postcode || '';
			document.getElementById('state').value = order.state || '';
			document.getElementById('status').value = order.status || '';
			document.getElementById('route_record').value = order.route_record || '';
			document.getElementById('urgent').value = order.urgent ? 'true' : 'false';
			document.getElementById('notes').value = order.notes || '';
			document.getElementById('customer_notes').value = order.customer_notes || '';
			document.getElementById('tracking_number').value = order.tracking_number || '';
			document.getElementById('delivery_date').value = order.delivery_date
				? toDateLocal(new Date(order.delivery_date))
				: '';

			// 清空旧行
			const tbody = document.getElementById('product-table-body');
			tbody.innerHTML = '';

			// 填充产品行
			order.products.forEach(item => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>
						<input type="hidden" name="product_id[]" value="${item.product_id}">
						<input type="text" class="form-control product-search" value="${item.name}" autocomplete="off">
						<div class="autocomplete-suggestions"></div>
					</td>
					<td>
						<input type="text" class="form-control barcode" placeholder="条码" name="barcode[]" value="${item.barcode}">
					</td>
					<td>
						<input type="text" class="form-control sku" placeholder="SKU" name="sku[]" value="${item.sku}">
					</td>
					<td>
						<input type="number" min="1" step="1" class="form-control" name="quantity[]" value="${item.quantity}" required>
					</td>
					<td>
						<button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">删除</button>
					</td>
				`;
				tbody.appendChild(row);
				enableProductSearch(row.querySelector('.product-search'));
			});

			// 标记当前是编辑状态
			document.getElementById('order-form').dataset.editingId = id;

			// 打开 modal
			document.getElementById('orderModalLabel').textContent = '编辑订单';
			const modal = new bootstrap.Modal(document.getElementById('orderModal'));
			modal.show();
		})
		.catch(error => {
			console.error('获取订单出错:', error);
			alert('无法获取订单数据');
		});
	}

	function getShippingQuotes(id) {
		const modal = new bootstrap.Modal(document.getElementById('shippingQuotesModal'));
		const loading = document.getElementById('quotes-loading');
		const quotesTable = document.getElementById('quotes-table');
		const quotesTbody = quotesTable.querySelector('tbody');
		const parcelsTable = document.getElementById('parcels-table');
		const parcelsTbody = parcelsTable.querySelector('tbody');

		// 清空旧数据
		quotesTbody.innerHTML = '';
		quotesTable.style.display = 'none';
		parcelsTbody.innerHTML = '';
		parcelsTable.style.display = 'none';
		loading.style.display = '';

		modal.show();

		fetch(`/orders/shipping_quotes/${id}/`)
		.then(res => res.json())
		.then(data => {
			loading.style.display = 'none';

			const parcelAttributes = data.parcel_attributes || [];
			if (parcelAttributes.length === 0) {
				parcelsTbody.innerHTML = `<tr><td colspan="4">读取包裹属性失败</td></tr>`;
			} else {
				for (const q of parcelAttributes) {
					const row = document.createElement('tr');
					row.innerHTML = `
						<td>${q.qty || ''}</td>
						<td>${q.weight || ''}kg</td>
						<td>${q.length || ''}m</td>
						<td>${q.width || ''}m</td>
						<td>${q.height || ''}m</td>
					`;
					parcelsTbody.appendChild(row);
				}
			}
			parcelsTable.style.display = '';

			const quotes = data.quotes || [];
			if (quotes.length === 0) {
				quotesTbody.innerHTML = `<tr><td colspan="4">无可用报价</td></tr>`;
			} else {
				for (const q of quotes) {
					const row = document.createElement('tr');
					row.innerHTML = `
						<td>${q.courier}</td>
						<td>${q.service_level}</td>
						<td>${parseFloat(q.price || 0).toFixed(2)}</td>
						<td>${q.eta}</td>
					`;
					quotesTbody.appendChild(row);
				}
			}
			quotesTable.style.display = '';
		})
		.catch(err => {
			loading.style.display = 'none';
			alert('无法连接到服务器: ' + err);
		});
	}
</script>
{% endblock %}
