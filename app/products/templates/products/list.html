{% extends 'base.html' %}

{% block content %}
<style>
table {
	width: 100%;
}
th {
	vertical-align: middle;
	line-height: 1;
	font-weight: 600;
	font-size: 0.75rem;
	text-align: center;
	white-space: normal;
	word-break: keep-all;
}
td {
	font-size: 0.75rem;
	text-align: center;
	vertical-align: middle;
	white-space: nowrap;
}
td.long-text {
	word-break: break-word;
	white-space: normal;
}
table select option {
	text-align-last: center;
}
.filter-input {
	width: 100%;
}
</style>

<div class="container mx-auto p-1">
	<h1 class="font-semibold text-teal-700 text-lg pb-2">产品列表</h1>

	<!-- 顶部操作栏 -->
	<div class="flex items-center justify-between mt-4">
		<div class="flex items-center space-x-2">
			<button type="button" class="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700" onclick="addProduct()">+ 添加产品</button>
		</div>
	</div>

	<!-- 表格区域 -->
	<div class="mt-4 bg-white shadow-md rounded-lg">
		<table class="min-w-max border-collapse text-sm">
			<thead class="bg-gray-100">
				<tr>
					<th class="p-1 border border-gray-300">类型</th>
					<th class="p-1 border border-gray-300">品种</th>
					<th class="p-1 border border-gray-300">厂家</th>
					<th class="p-1 border border-gray-300">产品名称</th>
					<th class="p-1 border border-gray-300">SKU</th>
					<th class="p-1 border border-gray-300">条码</th>
					<th class="p-1 border border-gray-300">操作</th>
				</tr>
				<tr>
					<th class="p-1 border border-gray-300">
						<select data-search_target="type" class="filter-variety border border-gray-300 p-1 rounded">
							<option value="所有">所有</option>
							{% for type in types %}
								<option value="{{ type }}">{{ type }}</option>
							{% endfor %}
						</select>
					</th>
					<th class="p-1 border border-gray-300">
						<select data-search_target="category" class="filter-variety border border-gray-300 p-1 rounded">
							<option value="所有">所有</option>
							{% for category in categories %}
								<option value="{{ category }}">{{ category }}</option>
							{% endfor %}
						</select>
					</th>
					<th class="p-1 border border-gray-300">
						<select data-search_target="manufacturer" class="filter-variety border border-gray-300 p-1 rounded">
							<option value="所有">所有</option>
							{% for manufacturer in manufacturers %}
								<option value="{{ manufacturer }}">{{ manufacturer }}</option>
							{% endfor %}
						</select>
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="name_cn" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="sku" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="barcode" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300"></th>
				</tr>
			</thead>
			<tbody>
				{% for product in products %}
				<tr class="hover:bg-gray-50">
					<td class="p-1 border border-gray-300" data-search_field="type">{{ product.type | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="category">{{ product.category | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="manufacturer">{{ product.manufacturer | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="name_cn">{{ product.name_cn | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="sku">{{ product.sku | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="barcode">{{ product.barcode | default:"" }}</td>
					<td class="p-1 border border-gray-300">
						<button class="text-blue-600 hover:underline" onclick="editProduct(`{{ product.id }}`)">编辑</button>
						<button class="text-red-600 hover:underline ml-2" onclick="deleteProduct(`{{ product.id }}`)">删除</button>
					</td>
				</tr>
				{% empty %}
				<tr>
					<td colspan="21" class="p-1 text-center text-gray-500">没有产品数据。</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>

{% include 'products/modal.html' %}

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const filterVarietys = Array.from(document.getElementsByClassName('filter-variety'));
		const filterInputs = Array.from(document.getElementsByClassName('filter-input'));
		const productTable = document.querySelector('tbody');

		function applyAllFilters() {
			const filters = {};

			// 收集下拉筛选器
			filterVarietys.forEach(select => {
				const field = select.dataset.search_target;
				const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
				if (!selectedValues.includes('所有')) {
					filters[field] = { type: 'select', values: selectedValues };
				}
			});

			// 收集文本输入筛选器
			filterInputs.forEach(input => {
				const field = input.dataset.search_target;
				const keyword = (input.value || '').trim().toLowerCase();
				if (keyword) {
					filters[field] = { type: 'text', keyword };
				}
			});

			const rows = productTable.querySelectorAll('tr');
			rows.forEach(row => {
				let visible = true;

				for (const [field, filter] of Object.entries(filters)) {
					const cell = row.querySelector(`td[data-search_field="${field}"]`);
					if (!cell) continue;

					const cellText = cell.textContent.trim();

					if (filter.type === 'select') {
						if (
							!filter.values.includes('所有') &&
							!(
								filter.values.includes(cellText) ||
								(cellText === '' && filter.values.includes('空'))
							)
						) {
							visible = false;
							break;
						}
					} else if (filter.type === 'text') {
						if (!cellText.match(new RegExp(filter.keyword, 'i'))) {
							visible = false;
							break;
						}
					}
				}

				row.style.display = visible ? '' : 'none';
			});
		}

		// 输入事件绑定
		filterInputs.forEach(input => {
			input.addEventListener('input', applyAllFilters);
		});

		// 下拉框事件绑定替换
		filterVarietys.forEach(select => {
			select.addEventListener('change', applyAllFilters);
		});

		// 可选：初始化默认值为“所有”
		filterVarietys.forEach(select => {
			const allOption = select.querySelector('option[value="所有"]');
			if (allOption) {
				allOption.selected = true;
			}
		});
	});
</script>
{% endblock %}
