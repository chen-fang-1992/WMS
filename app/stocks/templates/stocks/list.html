{% extends 'base.html' %}

{% block content %}
<style>
table {
	width: 100%;
}
th {
	vertical-align: middle;
	line-height: 1;
	font-weight: 600;
	font-size: 0.75rem;
	text-align: center;
	white-space: normal;
	word-break: keep-all;
}
td {
	font-size: 0.75rem;
	text-align: center;
	vertical-align: middle;
	white-space: nowrap;
}
select option {
	text-align-last: center;
}
.text-green-600 {
	color: #16a34a !important;
}
.text-red-600 {
	color: #dc2626 !important;
}
.filter-input {
	width: 100%;
}
</style>

<div class="container mx-auto p-1">
	<h1 class="font-semibold text-teal-700 text-lg pb-2">库存列表</h1>

	<!-- 顶部操作栏 -->
	<div class="flex items-center justify-between mt-4">
		<div class="flex items-center space-x-2">
			<button type="button" class="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700" onclick="exportStock()">
				<i class="bi bi-file-earmark-arrow-down"></i> 导出库存
			</button>
		</div>
	</div>

	<!-- 表格区域 -->
	<div class="mt-4 bg-white shadow-md rounded-lg w-full overflow-x-auto">
		<table class="w-full border-collapse text-sm w-100">
			<colgroup>
				<col style="width: 45%;">
				<col style="width: 40%;">
				<col style="width: 15%;">
			</colgroup>
			<thead class="bg-gray-100">
				<tr>
					<th class="p-1 border border-gray-300">产品</th>
					<th class="p-1 border border-gray-300">SKU</th>
					<th class="p-1 border border-gray-300">数量</th>
					<th class="p-1 border border-gray-300">操作</th>
				</tr>
				<tr>
					<th class="p-1 border border-gray-300">
						<input data-search_target="product" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="sku" data-search_type="text" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
					</th>
					<th class="p-1 border border-gray-300">
						<input data-search_target="quantity" data-search_type="number" type="text" class="filter-input border border-gray-300 p-1 rounded text-sm text-center" />
					</th>
				</tr>
			</thead>
			<tbody>
				{% for stock in stocks %}
				<tr class="hover:bg-gray-50">
					<td class="p-1 border border-gray-300" data-search_field="product">{{ stock.product | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="sku">{{ stock.product.sku | default:"" }}</td>
					<td class="p-1 border border-gray-300" data-search_field="quantity">{{ stock.quantity | default:"" }}</td>
					<td class="p-1 border border-gray-300">
						<button class="text-blue-600 hover:underline" onclick="viewStock(`{{ stock.id }}`)">查看</button>
					</td>
				</tr>
				{% empty %}
				<tr>
					<td colspan="21" class="p-1 text-center text-gray-500">没有库存数据。</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>

<!-- 弹窗 -->
<div class="modal fade" id="stockModal" tabindex="-1" aria-labelledby="stockModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="stockModalLabel">查看库存</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<h6 class="mt-3">变动记录</h6>
				<table class="table table-bordered text-sm" id="product-table">
					<colgroup>
						<col style="width: 20%;">
						<col style="width: 20%;">
						<col style="width: 20%;">
						<col style="width: 20%;">
						<col style="width: 20%;">
					</colgroup>
					<thead>
						<tr>
							<th>日期</th>
							<th>参考号</th>
							<th>入库</th>
							<th>出库</th>
							<th>总计</th>
						</tr>
					</thead>
					<tbody id="product-table-body">
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const filterVarietys = Array.from(document.getElementsByClassName('filter-variety'));
		const filterInputs = Array.from(document.getElementsByClassName('filter-input'));
		const productTable = document.querySelector('tbody');

		function normalizeNumber(text) {
			if (text == null) return null;
			// 去千分位、空格
			const clean = String(text).replace(/[, ]+/g, '');
			const n = Number(clean);
			return Number.isFinite(n) ? n : null;
		}

		function parseDate(text) {
			// 支持 YYYY, YYYY-MM, YYYY-MM-DD
			if (/^\d{4}$/.test(text)) {
				// 年份 -> 返回 1 月 1 日
				return new Date(text + '-01-01T00:00:00');
			}
			if (/^\d{4}-\d{2}$/.test(text)) {
				// 年-月 -> 返回该月 1 日
				return new Date(text + '-01T00:00:00');
			}
			if (/^\d{4}-\d{2}-\d{2}$/.test(text)) {
				return new Date(text + 'T00:00:00');
			}
			return null;
		}

		function cmp(a, b) {
			// 比较器：返回 -1/0/1
			if (a < b) return -1;
			if (a > b) return 1;
			return 0;
		}

		// 把“查询字符串 + 类型”编译成一个判断单元格文本是否命中的函数
		function buildPredicate(query, type) {
			const raw = (query || '').trim();
			if (!raw) {
				return () => true;
			}

			// 支持以空格分隔的 AND；以竖线 | 分隔的 OR
			// 例：">=10 <20"（AND），或者 "10-20|>=50"（OR）
			const orParts = raw.split('|').map(s => s.trim()).filter(Boolean);

			const tokenPredicates = orParts.map(orExpr => {
				const andTokens = orExpr.split(/\s+/).filter(Boolean).map(tok => tok.trim());
				const preds = andTokens.map(tok => makeTokenPredicate(tok, type));
				return (cellText) => preds.every(p => p(cellText));
			});

			return (cellText) => tokenPredicates.some(p => p(cellText));
		}

		function makeTokenPredicate(token, type) {
			// 统一处理：比较运算、区间、等值模糊
			// 支持：<=,>=,<,>,=,!=, 区间 a-b 或 a..b
			const opMatch = token.match(/^(<=|>=|<|>|=|!=)\s*(.+)$/);
			const rangeMatch = token.match(/^(.+?)(?:\.\.|-)(.+)$/);

			if (type === 'number') {
				return makeNumberPredicate(token, opMatch, rangeMatch);
			}
			if (type === 'date') {
				return makeDatePredicate(token, opMatch, rangeMatch);
			}
			// text：回退为大小写不敏感包含
			const rx = new RegExp(token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
			return (cellText) => rx.test(String(cellText || '').trim());
		}

		function makeNumberPredicate(token, opMatch, rangeMatch) {
			if (opMatch) {
				const [, op, rhsRaw] = opMatch;
				const rhs = normalizeNumber(rhsRaw);
				if (rhs == null) return () => false;
				return (cellText) => {
					const v = normalizeNumber(String(cellText || '').trim());
					if (v == null) return false;
					switch (op) {
						case '<=': return v <= rhs;
						case '>=': return v >= rhs;
						case '<':  return v <  rhs;
						case '>':  return v >  rhs;
						case '=':  return v === rhs;
						case '!=': return v !== rhs;
						default:   return false;
					}
				};
			}
			if (rangeMatch) {
				const lhs = normalizeNumber(rangeMatch[1]);
				const rhs = normalizeNumber(rangeMatch[2]);
				if (lhs == null || rhs == null) return () => false;
				const lo = Math.min(lhs, rhs);
				const hi = Math.max(lhs, rhs);
				return (cellText) => {
					const v = normalizeNumber(String(cellText || '').trim());
					return v != null && v >= lo && v <= hi;
				};
			}
			// 纯数字：等值；否则按包含
			const val = normalizeNumber(token);
			if (val != null) {
				return (cellText) => {
					const v = normalizeNumber(String(cellText || '').trim());
					return v === val;
				};
			}
			const rx = new RegExp(token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
			return (cellText) => rx.test(String(cellText || '').trim());
		}

		function makeDatePredicate(token, opMatch, rangeMatch) {
			if (opMatch) {
				const [, op, rhsRaw] = opMatch;
				const rhs = parseDate(rhsRaw);
				if (!rhs) return () => false;
				return (cellText) => {
					const v = parseDate(String(cellText || '').trim());
					if (!v) return false;
					switch (op) {
						case '<=': return cmp(v, rhs) <= 0;
						case '>=': return cmp(v, rhs) >= 0;
						case '<':  return cmp(v, rhs) <  0;
						case '>':  return cmp(v, rhs) >  0;
						case '=':  return cmp(v, rhs) === 0;
						case '!=': return cmp(v, rhs) !== 0;
						default:   return false;
					}
				};
			}
			if (rangeMatch) {
				const d1 = parseDate(rangeMatch[1]);
				const d2 = parseDate(rangeMatch[2]);
				if (!d1 || !d2) return () => false;
				const lo = d1 < d2 ? d1 : d2;
				const hi = d1 < d2 ? d2 : d1;
				return (cellText) => {
					const v = parseDate(String(cellText || '').trim());
					return !!v && v >= lo && v <= hi;
				};
			}
			// 纯日期：等值；否则按包含
			const val = parseDate(token);
			if (val) {
				return (cellText) => {
					const v = parseDate(String(cellText || '').trim());
					return !!v && cmp(v, val) === 0;
				};
			}
			const rx = new RegExp(token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
			return (cellText) => rx.test(String(cellText || '').trim());
		}

		function applyAllFilters() {
			const filters = {};

			// 收集下拉筛选器
			filterVarietys.forEach(select => {
				const field = select.dataset.search_target;
				const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
				if (!selectedValues.includes('所有')) {
					filters[field] = { type: 'select', values: selectedValues };
				}
			});

			// 收集文本输入筛选器
			filterInputs.forEach(input => {
				const field = input.dataset.search_target;
				const ftype = (input.dataset.search_type || 'text').toLowerCase(); // text | number | date
				const query = (input.value || '').trim();
				if (query) {
					filters[field] = {
						type: 'predicate',
						predicate: buildPredicate(query, ftype)
					};
				}
			});

			const rows = productTable.querySelectorAll('tr');
			rows.forEach(row => {
				let visible = true;

				for (const [field, filter] of Object.entries(filters)) {
					const cell = row.querySelector(`td[data-search_field="${field}"]`);
					if (!cell) continue;

					const cellText = cell.textContent.trim();

					if (filter.type === 'select') {
						if (
							!filter.values.includes('所有') &&
							!(
								filter.values.includes(cellText) ||
								(cellText === '' && filter.values.includes('空'))
							)
						) {
							visible = false;
							break;
						}
					} else if (filter.type === 'predicate') {
						if (!filter.predicate(cellText)) {
							visible = false;
							break;
						}
					}
				}
				
				row.style.display = visible ? '' : 'none';
			});
		}

		// 输入事件绑定
		filterInputs.forEach(input => {
			input.addEventListener('input', applyAllFilters);
		});

		// 下拉框事件绑定替换
		filterVarietys.forEach(select => {
			select.addEventListener('change', applyAllFilters);
		});

		// 可选：初始化默认值为“所有”
		filterVarietys.forEach(select => {
			const allOption = select.querySelector('option[value="所有"]');
			if (allOption) {
				allOption.selected = true;
			}
		});
	});

	function viewStock(id) {
		fetch(`/stocks/detail/${id}/`)
		.then(res => res.json())
		.then(data => {
			if (!data.success) {
				alert('获取库存信息失败: ' + data.error);
				return;
			}

			const stock = data.stock;
			const tbody = document.getElementById('product-table-body');
			tbody.innerHTML = '';  // 清空旧行

			let balance = 0;

			stock.history.forEach(item => {
				balance += item.quantity;

				const isInbound = item.quantity >= 0;
				const inboundQty = isInbound ? item.quantity : '';
				const outboundQty = !isInbound ? -item.quantity : '';

				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${item.date}</td>
					<td>${item.reference}</td>
					<td class="text-green-600">${inboundQty}</td>
					<td class="text-red-600">${outboundQty}</td>
					<td>${balance}</td>
				`;
				tbody.appendChild(row);
			});

			document.getElementById('stockModalLabel').textContent = `查看库存 - ${stock.product}`;
			const modal = new bootstrap.Modal(document.getElementById('stockModal'));
			modal.show();
		})
		.catch(error => {
			console.error('获取库存出错:', error);
			alert('无法获取库存数据');
		});
	}

	function exportStock() {
		const url = "/stocks/export/";

		// 如需带筛选参数（示例：只导出非0库存）
		// const url = "/stocks/export/?only_nonzero=1&q=" + encodeURIComponent(document.querySelector('#keyword')?.value || '');

		window.location.href = url;
	}
</script>
{% endblock %}
