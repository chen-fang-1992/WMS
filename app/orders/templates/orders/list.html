{% extends 'base.html' %}

{% load order_tags %}

{% block content %}
<style>
table {
	width: 100%;
}
th {
	vertical-align: middle;
	line-height: 1;
	font-weight: 600;
	font-size: 0.75rem;
	text-align: center;
	white-space: normal;
	word-break: keep-all;
}
td {
	font-size: 0.75rem;
	text-align: center;
	vertical-align: middle;
	white-space: nowrap;
}
select option {
	text-align-last: center;
}
</style>

<div class="container mx-auto p-1">
	<h1 class="font-semibold text-teal-700 text-lg pb-2">订单列表</h1>

	<!-- 顶部操作栏 -->
	<div class="flex items-center justify-between mt-4">
		<div class="flex items-center space-x-2">
			<button type="button" class="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700" onclick="addOrder()">
				<i class="bi bi-plus-lg"></i> 添加订单
			</button>
		</div>
	</div>

	<!-- 表格区域 -->
	<div class="mt-4 bg-white shadow-md rounded-lg w-full overflow-x-auto">
		<table class="w-full border-collapse text-sm w-100">
			<thead class="bg-gray-100">
				<tr>
					<th class="p-1 border border-gray-300">订单号码</th>
					<th class="p-1 border border-gray-300">日期</th>
					<th class="p-1 border border-gray-300">进度</th>
					<th class="p-1 border border-gray-300">联系人</th>
					<th class="p-1 border border-gray-300">电话</th>
					<th class="p-1 border border-gray-300">地址</th>
					<th class="p-1 border border-gray-300">Suburb</th>
					<th class="p-1 border border-gray-300">Postcode</th>
					<th class="p-1 border border-gray-300">State</th>
					<th class="p-1 border border-gray-300">产品</th>
					<th class="p-1 border border-gray-300">路线记录</th>
					<th class="p-1 border border-gray-300">备注</th>
					<th class="p-1 border border-gray-300">操作</th>
				</tr>
				<tr>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300">
						<select data-col="3" class="filter-variety border border-gray-300 p-1 rounded">
							<option value="所有">所有</option>
							{% for value, label in statuses %}
								<option value="{{ value }}">{{ label }}</option>
							{% endfor %}
						</select>
					</th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
					<th class="p-1 border border-gray-300"></th>
				</tr>
			</thead>
			<tbody>
				{% for order in orders %}
				<tr class="hover:bg-gray-50">
					<td class="p-1 border border-gray-300">{{ order.reference | default:"" }}</td>
					<td class="p-1 border border-gray-300">{{ order.date | default:"" }}</td>
					<td class="p-1 border border-gray-300">{{ order.status | status_label }}</td>
					<td class="p-1 border border-gray-300">{{ order.contact_name | default:"" }}</td>
					<td class="p-1 border border-gray-300">{{ order.phone | default:"" }}</td>
					<td class="p-1 border border-gray-300">{{ order.address | default:"" }}</td>
					<td class="p-1 border border-gray-300">{{ order.suburb | default:"" }}</td>
					<td class="p-1 border border-gray-300">{{ order.postcode | default:"" }}</td>
					<td class="p-1 border border-gray-300">{{ order.state | default:"" }}</td>
					<td class="p-1 border border-gray-300">
						{% for line in order.lines.all %}
						<div>
							{% if line.product.name_cn %}
								{{ line.product.name_cn }}
							{% else %}
								{{ line.product.name_en }}
							{% endif %} * {{ line.quantity }}
						</div>
						{% endfor %}
					</td>
					<td class="p-1 border border-gray-300">{{ order.route_record | default:"" }}</td>
					<td class="p-1 border border-gray-300">{{ order.notes | default:"" }}</td>
					<td class="p-1 border border-gray-300">
						<button class="text-blue-600 hover:underline" onclick="editOrder(`{{ order.id }}`)">编辑</button>
						<button class="text-red-600 hover:underline ml-2" onclick="deleteOrder(`{{ order.id }}`)">删除</button>
					</td>
				</tr>
				{% empty %}
				<tr>
					<td colspan="9" class="p-1 text-center text-gray-500">没有订单数据。</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>

{% include 'orders/modal.html' %}

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const filterVarietys = Array.from(document.getElementsByClassName('filter-variety'));
		const filterInputs = Array.from(document.getElementsByClassName('filter-input'));
		const productTable = document.querySelector('tbody');

		function applyAllFilters() {
			const filters = {};

			// 收集下拉筛选器
			filterVarietys.forEach(select => {
				const colIndex = parseInt(select.dataset.col) - 1;
				const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
				filters[colIndex] = { type: 'select', values: selectedValues };
			});

			// 收集文本输入筛选器
			filterInputs.forEach(input => {
				const colIndex = parseInt(input.dataset.col) - 1;
				const keyword = input.value.trim().toLowerCase();
				if (keyword) {
					filters[colIndex] = { type: 'text', keyword: keyword };
				}
			});

			const rows = productTable.querySelectorAll('tr');
			rows.forEach(row => {
				let visible = true;

				for (const [col, filter] of Object.entries(filters)) {
					const cell = row.querySelector(`td:nth-child(${parseInt(col) + 1})`);
					if (!cell) continue;

					const cellText = cell.textContent.trim();

					if (filter.type === 'select') {
						if (
							!filter.values.includes('所有') &&
							!(
								filter.values.includes(cellText) ||
								(cellText === '' && filter.values.includes('空'))
							)
						) {
							visible = false;
							break;
						}
					} else if (filter.type === 'text') {
						if (!cellText.match(new RegExp(filter.keyword, 'i'))) {
							visible = false;
							break;
						}
					}
				}

				row.style.display = visible ? '' : 'none';
			});
		}

		// 输入事件绑定
		filterInputs.forEach(input => {
			input.addEventListener('input', applyAllFilters);
		});

		// 下拉框事件绑定替换
		filterVarietys.forEach(select => {
			select.addEventListener('change', applyAllFilters);
		});

		// 可选：初始化默认值为“所有”
		filterVarietys.forEach(select => {
			const allOption = select.querySelector('option[value="所有"]');
			if (allOption) {
				allOption.selected = true;
			}
		});
	});

	function addOrder() {
		// 清空表单
		document.getElementById('order-form').reset();
		document.getElementById('order-form').dataset.editingId = '';  // 清除编辑状态

		// 清空旧行
		const tbody = document.getElementById('product-table-body');
		tbody.innerHTML = '';

		// 打开 modal
		document.getElementById('orderModalLabel').textContent = '添加订单';
		const modal = new bootstrap.Modal(document.getElementById('orderModal'));
		modal.show();
	}

	function deleteOrder(id) {
		if (confirm(`确认删除订单`)) {
			// 调用后端删除接口
			fetch(`/orders/delete/${id}/`, {
				method: 'POST',
			}).then(res => {
				if (res.ok) location.reload();
				else alert('删除失败');
			});
		}
	}

	function editOrder(id) {
		fetch(`/orders/detail/${id}/`)
		.then(res => res.json())
		.then(data => {
			if (!data.success) {
				alert('获取订单信息失败: ' + data.error);
				return;
			}

			const order = data.order;

			// 填充基本信息
			document.getElementById('reference').value = order.reference || '';
			document.getElementById('date').value = order.date || '';
			document.getElementById('contact_name').value = order.contact_name || '';
			document.getElementById('phone').value = order.phone || '';
			document.getElementById('email').value = order.email || '';
			document.getElementById('address').value = order.address || '';
			document.getElementById('suburb').value = order.suburb || '';
			document.getElementById('postcode').value = order.postcode || '';
			document.getElementById('state').value = order.state || '';
			document.getElementById('status').value = order.status || '';
			document.getElementById('route_record').value = order.route_record || '';
			document.getElementById('notes').value = order.notes || '';
			document.getElementById('customer_notes').value = order.customer_notes || '';

			// 清空旧行
			const tbody = document.getElementById('product-table-body');
			tbody.innerHTML = '';

			// 填充产品行
			order.products.forEach(item => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>
						<input type="hidden" name="product_id[]" value="${item.product_id}">
						<input type="text" class="form-control product-search" value="${item.name}" autocomplete="off">
						<div class="autocomplete-suggestions"></div>
					</td>
					<td>
						<input type="text" class="form-control sku" placeholder="SKU" value="${item.sku}" readonly aria-readonly="true">
					</td>
					<td>
						<input type="number" min="1" step="1" class="form-control" name="quantity[]" value="${item.quantity}" required>
					</td>
					<td>
						<button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">删除</button>
					</td>
				`;
				tbody.appendChild(row);
				enableProductSearch(row.querySelector('.product-search'));
			});

			// 标记当前是编辑状态
			document.getElementById('order-form').dataset.editingId = id;

			// 打开 modal
			document.getElementById('orderModalLabel').textContent = '编辑订单';
			const modal = new bootstrap.Modal(document.getElementById('orderModal'));
			modal.show();
		})
		.catch(error => {
			console.error('获取订单出错:', error);
			alert('无法获取订单数据');
		});
	}
</script>
{% endblock %}
