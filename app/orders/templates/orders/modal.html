<style>
#orderModal {
	font-size: 0.85em;
}
.autocomplete-suggestions {
	position: absolute;
	background-color: white;
	border: 1px solid #ddd;
	border-radius: 4px;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
	z-index: 9999;
	max-height: 200px;
	overflow-y: auto;
	width: 100%;
	margin-top: 2px;
	padding: 4px 0;
	display: none;
}

.autocomplete-option {
	padding: 8px 12px;
	font-size: 0.85rem;
	border-bottom: 1px solid #eee;
	cursor: pointer;
	transition: background-color 0.2s ease;
}

.autocomplete-option:last-child {
	border-bottom: none;
}

.autocomplete-option:hover {
	background-color: #f0f0f0;
}

#product-table .barcode {
	background-color: #e9ecef;
	border-color: #ced4da;
	cursor: not-allowed;
	pointer-events: none;
}

#product-table .sku {
	background-color: #e9ecef;
	border-color: #ced4da;
	cursor: not-allowed;
	pointer-events: none;
}

#order-form .form-label {
	margin-bottom: 0.2rem;
}

#order-form .row.compact-row {
	--bs-gutter-x: 0.75rem;
	--bs-gutter-y: 0.25rem;
}

#order-form .compact-section-gap {
	margin-bottom: 0.6rem !important;
}

#parcel-table input[type="number"] {
	min-width: 72px;
}
</style>

<!-- 弹窗 -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<form id="order-form">
				<div class="modal-header">
					<h5 class="modal-title" id="orderModalLabel">新增订单</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="row compact-row compact-section-gap">
						<div class="col-md-3">
							<label for="reference" class="form-label">订单号码</label>
							<input type="text" class="form-control" id="reference" required>
						</div>
						<div class="col-md-3">
							<label for="date" class="form-label">日期</label>
							<input type="datetime-local" class="form-control" id="date" required>
						</div>
						<div class="col-md-3">
							<label for="status" class="form-label">进度</label>
							<select class="form-control" id="status" required>
								<option value="">请选择</option>
								{% for value, label in statuses %}
									<option value="{{ value }}">{{ label }}</option>
								{% endfor %}
							</select>
						</div>
						<div class="col-md-3">
							<label for="urgent" class="form-label">加急单</label>
							<select class="form-control" id="urgent">
								<option value="false" selected>否</option>
								<option value="true">是</option>
							</select>
						</div>
					</div>
					<div class="row compact-row compact-section-gap">
						<div class="col-md-4">
							<label for="contact_name" class="form-label">联系人</label>
							<input type="text" class="form-control" id="contact_name" required>
						</div>
						<div class="col-md-4">
							<label for="phone" class="form-label">电话</label>
							<input type="text" class="form-control" id="phone" required>
						</div>
						<div class="col-md-4">
							<label for="email" class="form-label">邮箱</label>
							<input type="text" class="form-control" id="email" required>
						</div>
					</div>
					<div class="row compact-row compact-section-gap">
						<div class="col-md-12">
							<label for="address" class="form-label">地址</label>
							<input type="text" class="form-control" id="address" required>
						</div>
					</div>
					<div class="row compact-row compact-section-gap">
						<div class="col-md-4">
							<label for="suburb" class="form-label">Suburb</label>
							<input type="text" class="form-control" id="suburb" required>
						</div>
						<div class="col-md-4">
							<label for="postcode" class="form-label">Postcode</label>
							<input type="text" class="form-control" id="postcode" required>
						</div>
						<div class="col-md-4">
							<label for="state" class="form-label">State</label>
							<input type="text" class="form-control" id="state" required>
						</div>
					</div>
					<div class="row compact-row compact-section-gap">
						<div class="col-md-6">
							<label for="customer_notes" class="form-label">客户备注</label>
							<textarea class="form-control" id="customer_notes" rows="2"></textarea>
						</div>
						<div class="col-md-6">
							<label for="notes" class="form-label">备注</label>
							<textarea class="form-control" id="notes" rows="2"></textarea>
						</div>
					</div>
					<div class="row compact-row compact-section-gap">
						<div class="col-md-4">
							<label for="route_record" class="form-label">路线记录</label>
							<select class="form-control" id="route_record">
								<option value="">请选择</option>
								{% for value, label in route_records %}
									<option value="{{ value }}">{{ label }}</option>
								{% endfor %}
							</select>
						</div>
						<div class="col-md-4">
							<label for="delivery_date" class="form-label">送货日期</label>
							<input type="date" class="form-control" id="delivery_date">
						</div>
						<div class="col-md-4">
							<label for="tracking_number" class="form-label">快递单号</label>
							<input type="text" class="form-control" id="tracking_number">
						</div>
					</div>
					<h6 class="mt-3">订单产品</h6>
					<table class="table table-bordered text-sm" id="product-table">
						<colgroup>
							<col style="width: 30%;">
							<col style="width: 30%;">
							<col style="width: 30%;">
							<col style="width: 10%;">
							<col style="width: 10%;">
						</colgroup>
						<thead>
							<tr>
								<th>产品</th>
								<th>条码</th>
								<th>SKU</th>
								<th>数量</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody id="product-table-body">
						</tbody>
					</table>
					<button type="button" class="btn btn-sm btn-secondary" onclick="addRow()">+ 添加行</button>
					<div class="compact-section-gap mt-3">
						<div class="d-flex align-items-center justify-content-between mb-2">
							<h6 class="mb-0">包裹信息（报价用）</h6>
							<div class="d-flex gap-2">
								<button type="button" class="btn btn-sm btn-outline-secondary" onclick="recalcParcelRowsFromOrder()">重新计算</button>
								<button type="button" class="btn btn-sm btn-secondary" onclick="addParcelRow()">+ 添加包裹</button>
							</div>
						</div>
						<table class="table table-bordered table-sm text-center align-middle mb-1" id="parcel-table">
							<thead>
								<tr>
									<th>件数</th>
									<th>重量(kg)</th>
									<th>长(m)</th>
									<th>宽(m)</th>
									<th>高(m)</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody id="parcel-table-body"></tbody>
						</table>
						<div class="text-muted small">可手动调整。保存订单后，Shippit 报价将使用这里的包裹信息。</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-primary" id="create-order-btn">保存</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const orderForm = document.getElementById('order-form');

		// 提交表单
		orderForm.addEventListener('submit', function (event) {
			event.preventDefault();

			const reference = document.getElementById('reference').value;
			const date = document.getElementById('date').value;
			const contact_name = document.getElementById('contact_name').value;
			const phone = document.getElementById('phone').value;
			const email = document.getElementById('email').value;
			const address = document.getElementById('address').value;
			const suburb = document.getElementById('suburb').value;
			const postcode = document.getElementById('postcode').value;
			const state = document.getElementById('state').value;
			const status = document.getElementById('status').value;
			const route_record = document.getElementById('route_record').value;
			const urgent = document.getElementById('urgent').value === 'true';
			const notes = document.getElementById('notes').value;
			const customer_notes = document.getElementById('customer_notes').value;
			const tracking_number = document.getElementById('tracking_number').value;
			const delivery_date = document.getElementById('delivery_date').value;

			const product_ids = Array.from(document.querySelectorAll('input[name="product_id[]"]')).map(input => input.value.trim());
			const barcodes = Array.from(document.querySelectorAll('input[name="barcode[]"]')).map(input => input.value.trim());
			const skus = Array.from(document.querySelectorAll('input[name="sku[]"]')).map(input => input.value.trim());
			const quantities = Array.from(document.querySelectorAll('input[name="quantity[]"]')).map(input => parseInt(input.value));
			const parcel_attributes = getParcelRows();

			const products = product_ids.map((product_id, index) => ({
				product_id,
				barcode: barcodes[index],
				sku: skus[index],
				quantity: quantities[index],
			}));

			// 验证必填字段
			if (!reference || !date) {
				alert('请填写所有必填字段。');
				return;
			}

			// 提交数据到服务器
			let url;
			if (orderForm.dataset.editingId) {
				// 编辑模式
				const id = orderForm.dataset.editingId;
				url = '/orders/update/' + id + '/';
				delete orderForm.dataset.editingId;  // 清除编辑状态
			} else {
				// 创建新订单
				url = '/orders/create/';
			}
			fetch(url, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					reference: reference,
					date: date,
					contact_name: contact_name,
					phone: phone,
					email: email,
					address: address,
					suburb: suburb,
					postcode: postcode,
					state: state,
					status: status,
					route_record: route_record,
					urgent: urgent,
					notes: notes,
					customer_notes: customer_notes,
					tracking_number: tracking_number,
					delivery_date: delivery_date,
					parcel_attributes: parcel_attributes,
					products: products,
				})
			})
			.then(response => response.json())
			.then(async data => {
				if (data.success) {
					alert('订单已保存成功');
					if (typeof window.handleOrderSaveSuccess === 'function') {
						await window.handleOrderSaveSuccess(data);
						return;
					}
					location.reload();  // fallback
				} else {
					alert('保存失败: ' + (data.error || '未知错误'));
				}
			})
			.catch(error => {
				console.error('提交出错:', error);
				alert('提交失败，请检查控制台');
			});

			// 隐藏弹窗
			const orderModalEl = document.getElementById('orderModal');
			const modal = orderModalEl ? bootstrap.Modal.getInstance(orderModalEl) : null;
			if (modal) modal.hide();
		});
	});

	function addRow() {
		const tbody = document.getElementById('product-table-body');
		const newRow = document.createElement('tr');
		newRow.innerHTML = `
			<td><input type="hidden" name="product_id[]" required><input type="text" class="form-control product-search" placeholder="输入条码或名称搜索" autocomplete="off"><div class="autocomplete-suggestions"></div></td>
			<td><input type="text" class="form-control barcode" placeholder="条码" name="barcode[]"></td>
			<td><input type="text" class="form-control sku" placeholder="SKU" name="sku[]"></td>
			<td><input type="number" min="1" step="1" class="form-control" name="quantity[]" required></td>
			<td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">删除</button></td>
		`;
		tbody.appendChild(newRow);
		enableProductSearch(newRow.querySelector('.product-search'));
	}

	function addParcelRow(parcel = null) {
		const tbody = document.getElementById('parcel-table-body');
		if (!tbody) return;
		const row = document.createElement('tr');
		const qty = parcel?.qty ?? 1;
		const weight = parcel?.weight ?? 1;
		const length = parcel?.length ?? 0.1;
		const width = parcel?.width ?? 0.1;
		const height = parcel?.height ?? 0.1;
		row.innerHTML = `
			<td><input type="number" min="1" step="1" class="form-control form-control-sm text-center" data-parcel-field="qty" value="${qty}"></td>
			<td><input type="number" min="0" step="0.001" class="form-control form-control-sm text-center" data-parcel-field="weight" value="${weight}"></td>
			<td><input type="number" min="0" step="0.01" class="form-control form-control-sm text-center" data-parcel-field="length" value="${length}"></td>
			<td><input type="number" min="0" step="0.01" class="form-control form-control-sm text-center" data-parcel-field="width" value="${width}"></td>
			<td><input type="number" min="0" step="0.01" class="form-control form-control-sm text-center" data-parcel-field="height" value="${height}"></td>
			<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeParcelRow(this)">删除</button></td>
		`;
		tbody.appendChild(row);
	}

	function removeParcelRow(button) {
		const row = button.closest('tr');
		if (row) row.remove();
	}

	function setParcelRows(parcels) {
		const tbody = document.getElementById('parcel-table-body');
		if (!tbody) return;
		tbody.innerHTML = '';
		(parcels || []).forEach(addParcelRow);
		if (!tbody.children.length) addParcelRow();
	}

	function getParcelRows() {
		const tbody = document.getElementById('parcel-table-body');
		if (!tbody) return [];
		return Array.from(tbody.querySelectorAll('tr')).map(row => {
			const getNum = (field, fallback = 0) => {
				const el = row.querySelector(`[data-parcel-field="${field}"]`);
				const n = Number(el?.value);
				return Number.isFinite(n) ? n : fallback;
			};
			return {
				qty: Math.max(1, Math.trunc(getNum('qty', 1))),
				weight: getNum('weight', 0),
				length: getNum('length', 0),
				width: getNum('width', 0),
				height: getNum('height', 0),
			};
		}).filter(p => p.qty > 0);
	}

	async function recalcParcelRowsFromOrder() {
		const orderId = document.getElementById('order-form')?.dataset.editingId;
		if (!orderId) {
			alert('请先保存订单后再使用自动计算，或手动添加包裹。');
			return;
		}
		try {
			const res = await fetch(`/orders/detail/${orderId}/`);
			const data = await res.json();
			if (!res.ok || !data.success) {
				alert('重新计算包裹信息失败');
				return;
			}
			setParcelRows(data.order?.parcel_attributes || []);
		} catch (e) {
			alert('重新计算包裹信息失败');
		}
	}

	function removeRow(button) {
		const row = button.closest('tr');
		row.remove();
	}

	function enableProductSearch(input) {
		input.addEventListener('input', function () {
			const query = this.value.trim();
			const suggestionsDiv = this.nextElementSibling;

			if (query.length < 2) {
				suggestionsDiv.innerHTML = '';
				suggestionsDiv.style.display = 'none';
				const skuInput = input.closest('tr').querySelector('.sku');
				if (skuInput) skuInput.value = '';
				const barcodeInput = input.closest('tr').querySelector('.barcode');
				if (barcodeInput) barcodeInput.value = '';
				return;
			}

			fetch(`/products/search/?q=${encodeURIComponent(query)}`)
				.then(res => res.json())
				.then(data => {
					suggestionsDiv.innerHTML = '';
					data.results.forEach(item => {
						const option = document.createElement('div');
						option.textContent = `${item.name_cn || item.name_en}（${item.barcode}）`;
						option.classList.add('autocomplete-option');
						option.addEventListener('click', () => {
							input.value = `${item.name_cn || item.name_en}`;
							input.previousElementSibling.value = item.id;  // hidden input
							const skuInput = input.closest('tr').querySelector('.sku');
							if (skuInput) skuInput.value = item.sku || item.barcode || '';
							const barcodeInput = input.closest('tr').querySelector('.barcode');
							if (barcodeInput) barcodeInput.value = item.barcode || '';
							suggestionsDiv.innerHTML = '';
							suggestionsDiv.style.display = 'none';
						});
						suggestionsDiv.appendChild(option);
					});
					suggestionsDiv.style.display = 'block';
				});
		});
	}
</script>
